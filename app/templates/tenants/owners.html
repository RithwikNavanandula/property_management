{% extends "base.html" %}
{% set active_page = "owners" %}
{% block title %}Owner Master — {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Owner Master{% endblock %}

{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
    <div style="display:flex;gap:12px;align-items:center">
        <input type="text" class="form-control" style="width:240px" placeholder="Search owners..." id="searchInput"
            oninput="loadOwners()">
    </div>
    <button class="btn btn-primary" onclick="openModal('addOwnerModal')">+ Add Owner</button>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name / Company</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ownersTable">
                <tr>
                    <td colspan="6" class="empty-state">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Owner Modal -->
<div class="modal-backdrop" id="addOwnerModal">
    <div class="modal" style="max-width:700px">
        <div class="modal-header">
            <h3>Add New Owner</h3><button class="modal-close" onclick="closeModal('addOwnerModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="ownerForm">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Owner Code*</label><input class="form-control"
                            name="owner_code" required></div>
                    <div class="form-group"><label class="form-label">Owner Type</label>
                        <select class="form-control" name="owner_type">
                            <option>Individual</option>
                            <option>Corporate</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">First Name</label><input class="form-control"
                            name="first_name"></div>
                    <div class="form-group"><label class="form-label">Last Name</label><input class="form-control"
                            name="last_name"></div>
                </div>
                <div class="form-group"><label class="form-label">Company Name</label><input class="form-control"
                        name="company_name"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Email</label><input class="form-control"
                            name="email" type="email"></div>
                    <div class="form-group"><label class="form-label">Phone</label><input class="form-control"
                            name="phone"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Tax ID</label><input class="form-control"
                            name="tax_id"></div>
                    <div class="form-group"><label class="form-label">Status</label>
                        <select class="form-control" name="status">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                </div>
                <hr style="margin:20px 0;opacity:0.1">
                <h4 style="margin-bottom:12px">Bank Details</h4>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Bank Account Name</label><input
                            class="form-control" name="bank_account_name"></div>
                    <div class="form-group"><label class="form-label">Bank Account Number</label><input
                            class="form-control" name="bank_account_number"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Bank Name</label><input class="form-control"
                            name="bank_name"></div>
                    <div class="form-group"><label class="form-label">Routing Number</label><input class="form-control"
                            name="routing_number"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addOwnerModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveOwner()">Save Owner</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function loadOwners() {
        const q = document.getElementById('searchInput').value;
        const url = `/api/owners?search=${encodeURIComponent(q)}`;
        try {
            const data = await apiFetch(url);
            const tbody = document.getElementById('ownersTable');
            if (!data.items.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No owners found</td></tr>';
                return;
            }
            tbody.innerHTML = data.items.map(o => `
                <tr>
                    <td><strong>${o.owner_code}</strong></td>
                    <td>${o.owner_type === 'Corporate' ? o.company_name : (o.first_name + ' ' + (o.last_name || ''))}</td>
                    <td>${o.email || '-'}</td>
                    <td>${o.phone || '-'}</td>
                    <td>${statusBadge(o.status)}</td>
                    <td><button class="btn btn-sm btn-secondary">Edit</button></td>
                </tr>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function saveOwner() {
        const d = {}; new FormData(document.getElementById('ownerForm')).forEach((v, k) => d[k] = v);
        try {
            await apiFetch('/api/owners', { method: 'POST', body: JSON.stringify(d) });
            closeModal('addOwnerModal'); showToast('Owner created successfully'); loadOwners();
        } catch (e) { showToast(e.message, 'error'); }
    }

    loadOwners();
</script>
{% endblock %}