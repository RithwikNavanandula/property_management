{% extends "base.html" %}
{% set active_page = "utilities" %}
{% block title %}Utilities ‚Äî {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Utilities & Meter Readings{% endblock %}

{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
    <div style="display:flex;gap:12px;align-items:center">
        <select class="form-control" style="width:150px" id="typeFilter" onchange="loadReadings()">
            <option value="">All Types</option>
            <option>Electricity</option>
            <option>Water</option>
            <option>Gas</option>
            <option>Internet</option>
            <option>Sewage</option>
        </select>
        <select class="form-control" style="width:120px" id="statusFilter" onchange="loadReadings()">
            <option value="">All Status</option>
            <option>Pending</option>
            <option>Billed</option>
            <option>Paid</option>
        </select>
    </div>
    <button class="btn btn-primary" onclick="openModal('addReadingModal')">+ Record Reading</button>
</div>

<!-- Summary Cards -->
<div class="stats-grid" id="utilityStats"></div>

<div class="card" style="margin-top:20px">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Meter #</th>
                    <th>Prev Reading</th>
                    <th>Curr Reading</th>
                    <th>Usage</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="readingsTable">
                <tr>
                    <td colspan="9" class="empty-state">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Reading Modal -->
<div class="modal-backdrop" id="addReadingModal">
    <div class="modal" style="max-width:700px">
        <div class="modal-header">
            <h3>Record Utility Reading</h3><button class="modal-close"
                onclick="closeModal('addReadingModal')">√ó</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
            <form id="readingForm">
                <input type="hidden" name="id" id="editReadingId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Utility Type*</label>
                        <select class="form-control" name="utility_type" required>
                            <option>Electricity</option>
                            <option>Water</option>
                            <option>Gas</option>
                            <option>Internet</option>
                            <option>Sewage</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Meter Number</label>
                        <input class="form-control" name="meter_number" placeholder="e.g. MTR-001">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Property</label>
                        <select class="form-control" name="property_id" id="utilPropSelect" onchange="loadUtilUnits()">
                            <option value="">Select Property</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Unit</label>
                        <select class="form-control" name="unit_id" id="utilUnitSelect">
                            <option value="">Select Unit</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Reading Date*</label>
                        <input class="form-control" name="reading_date" type="date" required>
                    </div>
                    <div class="form-group"><label class="form-label">Status</label>
                        <select class="form-control" name="status">
                            <option>Pending</option>
                            <option>Billed</option>
                            <option>Paid</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Previous Reading</label>
                        <input class="form-control" name="previous_reading" type="number" step="0.01" value="0">
                    </div>
                    <div class="form-group"><label class="form-label">Current Reading*</label>
                        <input class="form-control" name="current_reading" type="number" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Rate per Unit</label>
                        <input class="form-control" name="rate_per_unit" type="number" step="0.0001" value="0">
                    </div>
                    <div class="form-group"><label class="form-label">Total Cost (auto-calc)</label>
                        <input class="form-control" name="total_cost" type="number" step="0.01"
                            placeholder="Auto-calculated">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Billing Period Start</label>
                        <input class="form-control" name="billing_period_start" type="date">
                    </div>
                    <div class="form-group"><label class="form-label">Billing Period End</label>
                        <input class="form-control" name="billing_period_end" type="date">
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addReadingModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveReading()">Save Reading</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openModal(id) {
        if (id === 'addReadingModal') {
            document.getElementById('readingForm').reset();
            document.getElementById('editReadingId').value = '';
            loadPropertyDropdowns();
        }
        document.getElementById(id).classList.add('active');
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function loadPropertyDropdowns() {
        const data = await apiFetch('/api/properties?limit=200');
        document.getElementById('utilPropSelect').innerHTML = '<option value="">Select Property</option>' +
            data.items.map(p => `<option value="${p.id}">${p.property_name}</option>`).join('');
    }

    async function loadUtilUnits() {
        const propId = document.getElementById('utilPropSelect').value;
        const sel = document.getElementById('utilUnitSelect');
        if (!propId) { sel.innerHTML = '<option value="">Select Unit</option>'; return; }
        const data = await apiFetch(`/api/properties/${propId}/units`);
        sel.innerHTML = '<option value="">Select Unit</option>' +
            data.items.map(u => `<option value="${u.id}">${u.unit_number}</option>`).join('');
    }

    async function loadReadings() {
        const type = document.getElementById('typeFilter').value;
        const status = document.getElementById('statusFilter').value;
        let url = '/api/utilities?';
        if (type) url += `utility_type=${type}&`;
        if (status) url += `status=${status}&`;

        try {
            const data = await apiFetch(url);
            const tbody = document.getElementById('readingsTable');
            if (!data.items.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No utility readings found</td></tr>';
                updateStats([]);
                return;
            }
            updateStats(data.items);
            tbody.innerHTML = data.items.map(r => `
                <tr>
                    <td>${formatDate(r.reading_date)}</td>
                    <td><span class="badge badge-${getTypeColor(r.utility_type)}">${r.utility_type}</span></td>
                    <td>${r.meter_number || '-'}</td>
                    <td>${r.previous_reading || 0}</td>
                    <td>${r.current_reading || 0}</td>
                    <td><strong>${r.usage || 0}</strong></td>
                    <td>${formatCurrency(r.total_cost)}</td>
                    <td>${statusBadge(r.status)}</td>
                    <td style="white-space:nowrap">
                        <button class="btn btn-sm btn-secondary" onclick="editReading(${r.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReading(${r.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { console.error(e); }
    }

    function getTypeColor(type) {
        const map = { 'Electricity': 'warning', 'Water': 'info', 'Gas': 'danger', 'Internet': 'purple', 'Sewage': 'neutral' };
        return map[type] || 'neutral';
    }

    function updateStats(items) {
        const stats = {};
        items.forEach(r => {
            if (!stats[r.utility_type]) stats[r.utility_type] = 0;
            stats[r.utility_type] += parseFloat(r.total_cost) || 0;
        });
        const icons = { 'Electricity': '‚ö°', 'Water': 'üíß', 'Gas': 'üî•', 'Internet': 'üåê', 'Sewage': 'üöø' };
        const colors = { 'Electricity': 'gold', 'Water': 'teal', 'Gas': 'pink', 'Internet': 'purple', 'Sewage': 'purple' };
        const total = Object.values(stats).reduce((a, b) => a + b, 0);
        let html = `<div class="stat-card teal"><div class="stat-icon">üìä</div><div class="stat-value">${items.length}</div><div class="stat-label">Total Readings</div></div>`;
        html += `<div class="stat-card gold"><div class="stat-icon">üí∞</div><div class="stat-value">${formatCurrency(total)}</div><div class="stat-label">Total Cost</div></div>`;
        for (const [type, cost] of Object.entries(stats)) {
            html += `<div class="stat-card ${colors[type] || 'purple'}"><div class="stat-icon">${icons[type] || 'üì¶'}</div><div class="stat-value">${formatCurrency(cost)}</div><div class="stat-label">${type}</div></div>`;
        }
        document.getElementById('utilityStats').innerHTML = html;
    }

    async function saveReading() {
        const d = {}; new FormData(document.getElementById('readingForm')).forEach((v, k) => {
            if (k === 'id') return;
            d[k] = v;
        });
        // Parse numerics
        ['property_id', 'unit_id'].forEach(k => {
            d[k] = d[k] ? parseInt(d[k]) : null;
        });
        ['previous_reading', 'current_reading', 'rate_per_unit', 'total_cost'].forEach(k => {
            if (d[k]) d[k] = parseFloat(d[k]);
        });

        try {
            const id = document.getElementById('editReadingId').value;
            if (id) {
                await apiFetch(`/api/utilities/${id}`, { method: 'PUT', body: JSON.stringify(d) });
                showToast('Reading updated');
            } else {
                await apiFetch('/api/utilities', { method: 'POST', body: JSON.stringify(d) });
                showToast('Reading recorded');
            }
            closeModal('addReadingModal'); loadReadings();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function editReading(id) {
        const r = await apiFetch(`/api/utilities/${id}`);
        document.getElementById('editReadingId').value = id;
        const form = document.getElementById('readingForm');
        ['utility_type', 'meter_number', 'reading_date', 'status',
            'previous_reading', 'current_reading', 'rate_per_unit', 'total_cost',
            'billing_period_start', 'billing_period_end', 'notes'].forEach(k => {
                const el = form.querySelector(`[name="${k}"]`);
                if (el && r[k] !== null && r[k] !== undefined) el.value = r[k];
            });
        await loadPropertyDropdowns();
        if (r.property_id) {
            document.getElementById('utilPropSelect').value = r.property_id;
            await loadUtilUnits();
            if (r.unit_id) document.getElementById('utilUnitSelect').value = r.unit_id;
        }
        document.getElementById('addReadingModal').classList.add('active');
    }

    async function deleteReading(id) {
        if (!confirm('Delete this reading?')) return;
        try {
            await apiFetch(`/api/utilities/${id}`, { method: 'DELETE' });
            showToast('Reading deleted'); loadReadings();
        } catch (e) { showToast(e.message, 'error'); }
    }

    loadReadings();
</script>
{% endblock %}