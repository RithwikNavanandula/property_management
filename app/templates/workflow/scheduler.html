{% extends "base.html" %}
{% block title %}Job Scheduler - {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Job Scheduler{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Background Jobs</h3>
        <button class="btn btn-primary" onclick="openNewJob()">‚ûï Add New Job</button>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Name</th>
                    <th>Type</th>
                    <th>Schedule</th>
                    <th>Frequency Info</th>
                    <th>Status</th>
                    <th>Last Run</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="jobsTable">
                <tr>
                    <td colspan="7">Loading jobs...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Job Modal -->
<div class="modal-backdrop" id="addJobModal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Add Job Schedule</h3><button class="modal-close"
                onclick="closeModal('addJobModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="jobForm">
                <input type="hidden" name="id" id="jobId">
                <div class="form-group">
                    <label class="form-label">Job Name*</label>
                    <input class="form-control" name="job_name" required placeholder="e.g. Generate Rent Invoices">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Job Type</label>
                        <select class="form-control" name="job_type">
                            <option>Generic</option>
                            <option>Email</option>
                            <option>Billing</option>
                            <option>Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Schedule Type</label>
                        <select class="form-control" name="schedule_type" id="scheduleType"
                            onchange="toggleScheduleFields()">
                            <option value="Cron">Cron Expression</option>
                            <option value="Interval">Interval (Minutes)</option>
                            <option value="Once">Once (Fixed Date)</option>
                            <option value="DailyMulti">Daily (Multiple Times)</option>
                        </select>
                    </div>
                </div>

                <div id="fieldCron" class="form-group">
                    <label class="form-label">Cron Expression (e.g. 0 0 * * *)</label>
                    <input class="form-control" name="cron_expression" placeholder="min hr day month dow">
                </div>

                <div id="fieldInterval" class="form-group" style="display:none">
                    <label class="form-label">Interval (Minutes)</label>
                    <input type="number" class="form-control" name="interval_minutes" placeholder="e.g. 60">
                </div>

                <div id="fieldDailyMulti" class="form-group" style="display:none">
                    <label class="form-label">Execution Times (JSON list of HH:MM)</label>
                    <input class="form-control" name="daily_times" id="dailyTimes" placeholder='["09:00", "21:00"]'>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" name="start_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date (Optional)</label>
                        <input type="datetime-local" class="form-control" name="end_date">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label"><input type="checkbox" id="isActiveCheck" checked> Active</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addJobModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveJob()">Save Schedule</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function toggleScheduleFields() {
        const type = document.getElementById('scheduleType').value;
        document.getElementById('fieldCron').style.display = type === 'Cron' ? 'block' : 'none';
        document.getElementById('fieldInterval').style.display = type === 'Interval' ? 'block' : 'none';
        document.getElementById('fieldDailyMulti').style.display = type === 'DailyMulti' ? 'block' : 'none';
    }

    function openNewJob() {
        document.getElementById('jobForm').reset();
        document.getElementById('jobId').value = '';
        document.getElementById('modalTitle').textContent = 'Add Job Schedule';
        document.getElementById('isActiveCheck').checked = true;
        toggleScheduleFields();
        openModal('addJobModal');
    }

    async function editJob(id) {
        const data = await apiFetch(`/api/workflow/jobs`);
        const job = data.items.find(j => j.id === id);
        if (!job) return;

        document.getElementById('jobId').value = job.id;
        document.getElementById('modalTitle').textContent = 'Edit Job Schedule';
        const form = document.getElementById('jobForm');
        form.querySelector('[name="job_name"]').value = job.job_name || '';
        form.querySelector('[name="job_type"]').value = job.job_type || 'Generic';
        form.querySelector('[name="schedule_type"]').value = job.schedule_type || 'Cron';
        form.querySelector('[name="cron_expression"]').value = job.cron_expression || '';
        form.querySelector('[name="interval_minutes"]').value = job.interval_minutes || '';
        form.querySelector('[name="daily_times"]').value = job.daily_times ? JSON.stringify(job.daily_times) : '';
        form.querySelector('[name="start_date"]').value = job.start_date ? job.start_date.slice(0, 16) : '';
        form.querySelector('[name="end_date"]').value = job.end_date ? job.end_date.slice(0, 16) : '';
        document.getElementById('isActiveCheck').checked = job.is_active;
        toggleScheduleFields();
        openModal('addJobModal');
    }

    async function loadJobs() {
        try {
            const data = await apiFetch('/api/workflow/jobs');
            const tbody = document.getElementById('jobsTable');
            if (!data.items || !data.items.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No scheduled jobs found</td></tr>';
                return;
            }
            tbody.innerHTML = data.items.map(j => `
                <tr>
                    <td><strong>${j.job_name}</strong></td>
                    <td><span class="badge badge-info">${j.job_type}</span></td>
                    <td>${j.schedule_type}</td>
                    <td>${formatFrequency(j)}</td>
                    <td><span class="badge ${j.is_active ? 'badge-success' : 'badge-warning'}">${j.is_active ? 'Active' : 'Paused'}</span></td>
                    <td>${j.last_run_at ? formatDate(j.last_run_at) : '-'}</td>
                    <td style="white-space:nowrap">
                        <button class="btn btn-sm btn-secondary" onclick="editJob(${j.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-secondary" onclick="runNow(${j.id})">‚ñ∂Ô∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJob(${j.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            document.getElementById('jobsTable').innerHTML = '<tr><td colspan="7">Error loading jobs</td></tr>';
        }
    }

    function formatFrequency(j) {
        if (j.schedule_type === 'Cron') return j.cron_expression || '-';
        if (j.schedule_type === 'Interval') return `Every ${j.interval_minutes}m`;
        if (j.schedule_type === 'DailyMulti') return Array.isArray(j.daily_times) ? j.daily_times.join(', ') : j.daily_times || '-';
        if (j.schedule_type === 'Once') return j.start_date ? formatDate(j.start_date) : '-';
        return '-';
    }

    async function saveJob() {
        const form = document.getElementById('jobForm');
        const formData = new FormData(form);
        const data = {};
        formData.forEach((v, k) => {
            if (k === 'id' && !v) return;
            if (v === '') {
                if (['start_date', 'end_date', 'interval_minutes', 'cron_expression'].includes(k)) {
                    data[k] = null;
                }
                return;
            }
            if (k === 'daily_times') {
                try {
                    const parsed = JSON.parse(v);
                    data[k] = Array.isArray(parsed) ? parsed : [v];
                } catch (e) {
                    data[k] = v ? [v] : [];
                }
            } else if (k === 'interval_minutes') {
                data[k] = parseInt(v) || null;
            } else {
                data[k] = v;
            }
        });

        // Explicitly handle checkbox ‚Äî not included in FormData when unchecked
        data.is_active = document.getElementById('isActiveCheck').checked;

        try {
            const id = document.getElementById('jobId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/workflow/jobs/${id}` : '/api/workflow/jobs';
            await apiFetch(url, { method, body: JSON.stringify(data) });
            closeModal('addJobModal');
            showToast('Schedule saved successfully');
            loadJobs();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function runNow(id) {
        try {
            await apiFetch(`/api/workflow/jobs/${id}/run`, { method: 'POST' });
            showToast('Job triggered manually');
            setTimeout(loadJobs, 2000);
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteJob(id) {
        if (!confirm('Are you sure you want to delete this job schedule?')) return;
        try {
            await apiFetch(`/api/workflow/jobs/${id}`, { method: 'DELETE' });
            showToast('Job deleted');
            loadJobs();
        } catch (e) { showToast(e.message, 'error'); }
    }

    loadJobs();
    toggleScheduleFields();
</script>
{% endblock %}