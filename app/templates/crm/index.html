{% extends "base.html" %}
{% set active_page = "crm" %}
{% block title %}CRM — {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Communications & CRM{% endblock %}

{% block content %}
<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'inbox')">Inbox</button>
    <button class="tab-btn" onclick="openTab(event, 'contacts')">Contacts</button>
    <button class="tab-btn" onclick="openTab(event, 'tasks')">Tasks</button>
</div>

<!-- Inbox Tab -->
<div id="inbox" class="tab-content" style="display:block;">
    <div class="grid-2" style="grid-template-columns: 1fr 2fr; gap: 20px; height: 600px;">
        <!-- Thread List -->
        <div class="card" style="overflow-y:auto;">
            <div class="actions-bar" style="padding:10px; border-bottom:1px solid #333;">
                <button class="btn btn-primary btn-sm btn-block" onclick="openModal('newThreadModal')">New
                    Message</button>
            </div>
            <div id="threadList" class="list-group">
                <!-- Populated by JS -->
            </div>
        </div>
        <!-- Message View -->
        <div class="card" style="display:flex; flex-direction:column;">
            <div id="messageHeader" style="padding:15px; border-bottom:1px solid #333; font-weight:bold;">
                Select a conversation
            </div>
            <div id="messageBody" style="flex:1; overflow-y:auto; padding:15px; background: rgba(0,0,0,0.2);">
                <!-- Messages populate here -->
            </div>
            <div id="messageInput" style="padding:15px; border-top:1px solid #333; display:none;">
                <form onsubmit="sendMessage(event)">
                    <div style="display:flex; gap:10px;">
                        <input type="text" name="body" class="form-control" placeholder="Type a message..." required>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Contacts Tab -->
<div id="contacts" class="tab-content">
    <div class="actions-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="contactSearch" placeholder="Search contacts...">
        </div>
        <button class="btn btn-primary" onclick="openModal('addContactModal')">Add Contact</button>
    </div>
    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="contactList"></tbody>
        </table>
    </div>
</div>

<!-- Tasks Tab -->
<div id="tasks" class="tab-content">
    <div class="actions-bar">
        <button class="btn btn-primary" onclick="openModal('addTaskModal')">New Task</button>
    </div>
    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Due Date</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                </tr>
            </thead>
            <tbody id="taskList"></tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script>
    let currentThreadId = null;

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        if (tabName === 'inbox') loadThreads();
        if (tabName === 'contacts') loadContacts();
        if (tabName === 'tasks') loadTasks();
    }

    async function loadThreads() {
        const resp = await fetch('/api/crm/threads');
        const data = await resp.json();
        const list = document.getElementById('threadList');
        list.innerHTML = '';
        data.items.forEach(t => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style = "padding:10px; border-bottom:1px solid #333; cursor:pointer;";
            div.innerHTML = `
                <div style="font-weight:bold;">${t.subject}</div>
                <div style="font-size:0.8em; color:#888;">${t.status} • ${new Date(t.created_at).toLocaleDateString()}</div>
            `;
            div.onclick = () => loadMessages(t.id, t.subject);
            list.appendChild(div);
        });
    }

    async function loadMessages(threadId, subject) {
        currentThreadId = threadId;
        document.getElementById('messageHeader').innerText = subject;
        document.getElementById('messageInput').style.display = 'block';

        const resp = await fetch(`/api/crm/threads/${threadId}/messages`);
        const data = await resp.json();
        const body = document.getElementById('messageBody');
        body.innerHTML = '';
        data.items.forEach(m => {
            body.innerHTML += `
                <div style="margin-bottom:10px; ${m.sender_type === 'User' ? 'text-align:right;' : ''}">
                    <div style="display:inline-block; padding:8px 12px; background:${m.sender_type === 'User' ? '#007bff' : '#333'}; border-radius:10px;">
                        ${m.body}
                        <div style="font-size:0.7em; opacity:0.7; margin-top:4px;">${new Date(m.sent_at).toLocaleString()}</div>
                    </div>
                </div>
            `;
        });
        body.scrollTop = body.scrollHeight;
    }

    async function sendMessage(e) {
        e.preventDefault();
        if (!currentThreadId) return;
        const input = e.target.elements.body;
        const body = input.value;

        await fetch(`/api/crm/threads/${currentThreadId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ body: body })
        });
        input.value = '';
        loadMessages(currentThreadId, document.getElementById('messageHeader').innerText);
    }

    async function loadContacts() {
        const resp = await fetch('/api/crm/contacts');
        const data = await resp.json();
        const tbody = document.getElementById('contactList');
        tbody.innerHTML = '';
        data.items.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>${c.first_name} ${c.last_name}</td>
                    <td>${c.contact_type}</td>
                    <td>${c.email}</td>
                    <td>${c.phone || '-'}</td>
                    <td>${c.status}</td>
                </tr>
            `;
        });
    }

    async function loadTasks() {
        const resp = await fetch('/api/crm/tasks');
        const data = await resp.json();
        const tbody = document.getElementById('taskList');
        tbody.innerHTML = '';
        data.items.forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td>${t.title}</td>
                    <td>${t.due_date ? new Date(t.due_date).toLocaleDateString() : '-'}</td>
                    <td><span class="badge badge-${getPriorityColor(t.priority)}">${t.priority}</span></td>
                    <td>${t.status}</td>
                    <td>${t.assigned_to || '-'}</td>
                </tr>
            `;
        });
    }

    function getPriorityColor(p) {
        if (p === 'High' || p === 'Urgent') return 'danger';
        if (p === 'Medium') return 'warning';
        return 'success';
    }

    // Initial load
    loadThreads();
</script>
{% endblock %}