{% extends "base.html" %}
{% set active_page = "properties" %}
{% block title %}Property Detail ‚Äî {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Property Detail{% endblock %}

{% block content %}
<div class="breadcrumb" style="margin-bottom:20px">
    <a href="/properties">Properties</a> <span>/</span> <span id="propName">Loading...</span>
</div>

<div class="stats-grid" id="propStats"></div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('buildings',this)">Buildings</div>
    <div class="tab" onclick="switchTab('floors',this)">Floors</div>
    <div class="tab" onclick="switchTab('units',this)">Units</div>
    <div class="tab" onclick="switchTab('details',this)">Details</div>
</div>

<div id="tabBuildings" class="card">
    <div class="card-header">
        <h3>Buildings</h3><button class="btn btn-sm btn-primary" onclick="openModal('addBldgModal')">+ Add
            Building</button>
    </div>
    <div id="buildingsList"></div>
</div>

<div id="tabFloors" class="card" style="display:none">
    <div class="card-header">
        <h3>Floors</h3>
        <div style="display:flex;gap:8px">
            <select class="form-control" id="bldgFilter" style="width:150px" onchange="loadFloors()"></select>
            <button class="btn btn-sm btn-primary" onclick="openModal('addFloorModal')">+ Add Floor</button>
        </div>
    </div>
    <div id="floorsList"></div>
</div>

<div id="tabUnits" class="card" style="display:none">
    <div class="card-header">
        <h3>Units</h3>
        <button class="btn btn-sm btn-primary" onclick="openModal('addUnitModal')">+ Add Unit</button>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Unit #</th>
                    <th>Building / Floor</th>
                    <th>Type</th>
                    <th>Area</th>
                    <th>Market Rent</th>
                    <th>Status</th>
                    <th>QR Code</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="unitsTable">
                <tr>
                    <td colspan="8">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="tabDetails" class="card" style="display:none">
    <div id="propDetails"></div>
</div>

<!-- Add Unit Modal -->
<div class="modal-backdrop" id="addUnitModal">
    <div class="modal" style="max-width:600px">
        <div class="modal-header">
            <h3>Add Unit</h3><button class="modal-close" onclick="closeModal('addUnitModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="unitForm">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Building</label>
                        <select class="form-control" name="building_id" id="unitBldg"
                            onchange="populateFloorDropdown('unitBldg', 'unitFloor')"></select>
                    </div>
                    <div class="form-group"><label class="form-label">Floor</label>
                        <select class="form-control" name="floor_id" id="unitFloor"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Unit Number*</label><input class="form-control"
                            name="unit_number" required></div>
                    <div class="form-group"><label class="form-label">Unit Name</label><input class="form-control"
                            name="unit_name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Unit Type</label>
                        <select class="form-control" name="unit_type">
                            <option>Studio</option>
                            <option>1BHK</option>
                            <option>2BHK</option>
                            <option>3BHK</option>
                            <option>Office Suite</option>
                            <option>Shop</option>
                            <option>Warehouse</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Usage Type</label><input class="form-control"
                            name="usage_type" placeholder="e.g. Residential, Retail"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Primary Tenant</label>
                        <select class="form-control" name="primary_tenant_id" id="unitTenantSelect">
                            <option value="">Select Tenant</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Area (sqft)</label><input class="form-control"
                            name="area_sqft" type="number" step="0.01"></div>
                    <div class="form-group"><label class="form-label">Area (sqm)</label><input class="form-control"
                            name="area_sqm" type="number" step="0.01"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Bedrooms</label><input class="form-control"
                            name="bedrooms" type="number" value="0"></div>
                    <div class="form-group"><label class="form-label">Bathrooms</label><input class="form-control"
                            name="bathrooms" type="number" value="0"></div>
                    <div class="form-group"><label class="form-label">Rooms</label><input class="form-control"
                            name="rooms" type="number" value="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Balconies</label><input class="form-control"
                            name="balconies" type="number" value="0"></div>
                    <div class="form-group"><label class="form-label">Parking Slots</label><input class="form-control"
                            name="parking_slots" type="number" value="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Ceiling Height (ft)</label><input
                            class="form-control" name="ceiling_height_ft" type="number" step="0.1"></div>
                    <div class="form-group"><label class="form-label">Load Capacity (tons)</label><input
                            class="form-control" name="load_capacity_tons" type="number" step="0.1"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Market Rent</label><input class="form-control"
                            name="market_rent" type="number" step="0.01"></div>
                    <div class="form-group"><label class="form-label">HVAC Type</label><input class="form-control"
                            name="hvac_type"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Min Lease Term (mo)</label><input
                            class="form-control" name="min_lease_term" type="number" value="12"></div>
                    <div class="form-group"><label class="form-label">Max Occupancy</label><input class="form-control"
                            name="max_occupancy" type="number" value="1"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Current Status</label>
                        <select class="form-control" name="current_status">
                            <option>Vacant</option>
                            <option>Occupied</option>
                            <option>Reserved</option>
                            <option>UnderMaintenance</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Record Status</label>
                        <select class="form-control" name="status">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Photo URL</label><input class="form-control"
                        name="photo_url"></div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-control"
                        name="description" rows="2"></textarea></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary"
                onclick="closeModal('addUnitModal')">Cancel</button><button class="btn btn-primary"
                onclick="saveUnit()">Save</button></div>
    </div>
</div>

<div class="modal-backdrop" id="addBldgModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Building</h3><button class="modal-close" onclick="closeModal('addBldgModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="bldgForm">
                <div class="form-group"><label class="form-label">Building Code*</label><input class="form-control"
                        name="building_code" required></div>
                <div class="form-group"><label class="form-label">Building Name*</label><input class="form-control"
                        name="building_name" required></div>
                <div class="form-group"><label class="form-label">Floors</label><input class="form-control"
                        name="floors_count" type="number" value="1"></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary"
                onclick="closeModal('addBldgModal')">Cancel</button><button class="btn btn-primary"
                onclick="saveBldg()">Save</button></div>
    </div>
</div>

<div class="modal-backdrop" id="addFloorModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Floor</h3><button class="modal-close" onclick="closeModal('addFloorModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="floorForm">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Building</label>
                        <select class="form-control" name="building_id" id="selBldgFloor"></select>
                    </div>
                    <div class="form-group"><label class="form-label">Floor Number*</label><input class="form-control"
                            name="floor_number" type="number" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Floor Name</label><input class="form-control"
                            name="floor_name"></div>
                    <div class="form-group"><label class="form-label">Total Units</label><input class="form-control"
                            name="total_units" type="number" value="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Floor Area (sqft)</label><input
                            class="form-control" name="floor_area_sqft" type="number" step="0.01"></div>
                    <div class="form-group"><label class="form-label">Status</label>
                        <select class="form-control" name="status">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary"
                onclick="closeModal('addFloorModal')">Cancel</button><button class="btn btn-primary"
                onclick="saveFloor()">Save</button></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const propId = {{ prop_id }};
    let buildings = [];
    let floorsCache = {};

    async function openModal(id) {
        if (id === 'addUnitModal') {
            await populateBuildingDropdown('unitBldg');
            await loadModalSelectionData();
        } else if (id === 'addFloorModal') {
            await populateBuildingDropdown('selBldgFloor');
        }
        document.getElementById(id).classList.add('active');
    }

    async function loadModalSelectionData() {
        try {
            const tenants = await apiFetch('/api/tenants?limit=100');
            const tSelect = document.getElementById('unitTenantSelect');
            tSelect.innerHTML = '<option value="">Select Tenant</option>' +
                tenants.items.map(t => `<option value="${t.id}">${t.first_name} ${t.last_name || ''}</option>`).join('');
        } catch (e) {
            console.error(e);
        }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active') }

    function switchTab(name, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); el.classList.add('active');
        ['buildings', 'floors', 'units', 'details'].forEach(t => {
            const el = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
            if (el) el.style.display = t === name ? 'block' : 'none';
        });
        if (name === 'floors') loadFloors();
    }

    async function loadProperty() {
        const p = await apiFetch(`/api/properties/${propId}`);
        document.getElementById('propName').textContent = p.property_name;
        document.getElementById('propStats').innerHTML = `
        <div class="stat-card purple"><div class="stat-icon">üè¢</div><div class="stat-value">${p.property_name}</div><div class="stat-label">${p.property_type} ¬∑ ${p.city || ''}</div></div>
        <div class="stat-card teal"><div class="stat-icon">üè†</div><div class="stat-value">${p.total_units || 0}</div><div class="stat-label">Total Units</div></div>
        <div class="stat-card pink"><div class="stat-icon">üìê</div><div class="stat-value">${p.total_area_sqft || '-'}</div><div class="stat-label">Total Area (sqft)</div></div>
        <div class="stat-card gold"><div class="stat-icon">üÖøÔ∏è</div><div class="stat-value">${p.parking_spaces || 0}</div><div class="stat-label">Parking Spaces</div></div>`;
        document.getElementById('propDetails').innerHTML = `<pre style="color:var(--text-secondary);font-size:13px;white-space:pre-wrap">${JSON.stringify(p, null, 2)}</pre>`;
        await loadBuildings();
        loadUnits();
    }

    async function loadUnits() {
        const data = await apiFetch(`/api/properties/${propId}/units`);
        const tbody = document.getElementById('unitsTable');
        if (!data.items.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><p>No units yet</p></td></tr>'; return; }

        tbody.innerHTML = data.items.map(u => {
            const bldg = buildings.find(b => b.id === u.building_id);
            return `<tr>
                <td><strong>${u.unit_number}</strong></td>
                <td>${bldg ? bldg.building_name : '-'} / ${u.floor_id || '-'}</td>
                <td>${u.unit_type || '-'}</td>
                <td>${u.area_sqft || '-'} sqft</td>
                <td>${formatCurrency(u.market_rent)}</td>
                <td>${statusBadge(u.current_status)}</td>
                <td>
                    ${u.qr_code_image_url ?
                    `<a href="${u.qr_code_image_url}" target="_blank"><img src="${u.qr_code_image_url}" style="width:30px;height:30px"></a>` :
                    `<button class="btn btn-sm btn-secondary" onclick="generateQR(${u.id})">QR</button>`}
                </td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="location.href='/properties/${propId}/units/${u.id}'">View</button>
                </td>
            </tr>`;
        }).join('');
    }

    async function generateQR(unitId) {
        try {
            await apiFetch(`/api/properties/${propId}/units/${unitId}/qrcode`, { method: 'POST' });
            showToast('QR Code generated');
            loadUnits();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function loadBuildings() {
        const data = await apiFetch(`/api/properties/${propId}/buildings`);
        buildings = data.items;
        document.getElementById('buildingsList').innerHTML = buildings.length ?
            buildings.map(b => `<div style="padding:16px;border-bottom:1px solid var(--border)"><strong>${b.building_code}</strong> ‚Äî ${b.building_name} (${b.floors_count} floors) ${statusBadge(b.status)}</div>`).join('') :
            '<p style="padding:16px;color:var(--text-muted)">No buildings yet</p>';

        const filter = document.getElementById('bldgFilter');
        filter.innerHTML = buildings.map(b => `<option value="${b.id}">${b.building_name}</option>`).join('');
        if (buildings.length && !filter.value) filter.value = buildings[0].id;
    }

    async function loadFloors() {
        const bldgId = document.getElementById('bldgFilter').value;
        if (!bldgId) return;
        const data = await apiFetch(`/api/properties/${propId}/buildings/${bldgId}/floors`);
        floorsCache[bldgId] = data.items;
        document.getElementById('floorsList').innerHTML = data.items.length ?
            data.items.map(f => `<div style="padding:16px;border-bottom:1px solid var(--border)">Floor <strong>${f.floor_number}</strong> ‚Äî ${f.floor_name || '-'} ${statusBadge(f.status)}</div>`).join('') :
            '<p style="padding:16px;color:var(--text-muted)">No floors found for this building</p>';
    }

    function populateBuildingDropdown(id) {
        const sel = document.getElementById(id);
        sel.innerHTML = buildings.map(b => `<option value="${b.id}">${b.building_name}</option>`).join('');
        if (id === 'unitBldg') populateFloorDropdown('unitBldg', 'unitFloor');
    }

    async function populateFloorDropdown(bldgSelId, floorSelId) {
        const bldgId = document.getElementById(bldgSelId).value;
        if (!bldgId) return;
        let floors = floorsCache[bldgId];
        if (!floors) {
            const data = await apiFetch(`/api/properties/${propId}/buildings/${bldgId}/floors`);
            floors = data.items;
            floorsCache[bldgId] = floors;
        }
        const sel = document.getElementById(floorSelId);
        sel.innerHTML = floors.map(f => `<option value="${f.id}">${f.floor_number} ${f.floor_name ? '(' + f.floor_name + ')' : ''}</option>`).join('');
    }

    async function saveUnit() {
        const d = {}; new FormData(document.getElementById('unitForm')).forEach((v, k) => { d[k] = v });

        // Parsing
        ['building_id', 'floor_id', 'primary_tenant_id', 'bedrooms', 'bathrooms', 'rooms', 'balconies', 'parking_slots', 'min_lease_term', 'max_occupancy'].forEach(k => {
            if (d[k]) d[k] = parseInt(d[k]) || null;
        });
        ['area_sqft', 'area_sqm', 'ceiling_height_ft', 'load_capacity_tons', 'market_rent'].forEach(k => {
            if (d[k]) d[k] = parseFloat(d[k]) || null;
        });

        await apiFetch(`/api/properties/${propId}/units`, { method: 'POST', body: JSON.stringify(d) });
        closeModal('addUnitModal'); showToast('Unit added'); loadUnits();
    }

    async function saveBldg() {
        const d = {}; new FormData(document.getElementById('bldgForm')).forEach((v, k) => { d[k] = v });
        d.floors_count = parseInt(d.floors_count) || 1;
        await apiFetch(`/api/properties/${propId}/buildings`, { method: 'POST', body: JSON.stringify(d) });
        closeModal('addBldgModal'); showToast('Building added'); await loadBuildings();
    }

    async function saveFloor() {
        const form = document.getElementById('floorForm');
        const d = {}; new FormData(form).forEach((v, k) => { d[k] = v });

        // Parsing
        ['building_id', 'floor_number', 'total_units'].forEach(k => {
            if (d[k]) d[k] = parseInt(d[k]) || null;
        });
        ['floor_area_sqft'].forEach(k => {
            if (d[k]) d[k] = parseFloat(d[k]) || null;
        });

        const bldgId = d.building_id;
        await apiFetch(`/api/properties/${propId}/buildings/${bldgId}/floors`, { method: 'POST', body: JSON.stringify(d) });
        closeModal('addFloorModal'); showToast('Floor added');
        delete floorsCache[bldgId];
        loadFloors();
    }

    loadProperty();
</script>
{% endblock %}